# 予測方法の説明

このWebアプリケーションは、**退院時のFIMデータを予測**するシステムです。

## 2つの予測方法

### 方法1: 距離ベース予測（`server.js`）

**現在デプロイされている方法**

- **仕組み**: データベース内の既存データから、入力値に最も近い患者データを探し、その患者の退院時データを返す
- **特徴**:
  - Rモデル不要
  - シンプルで高速
  - 既存データに基づく予測
- **使用ファイル**: `server.js`

**予測の流れ**:
1. 入力データ（入院時のFIM値、個人情報）を受け取る
2. データベースから完全一致または最も近いデータを検索
3. 見つかった患者の退院時データを返す

### 方法2: Rモデル予測（`server_r_model.js`）

**Rで学習した機械学習モデルを使用**

- **仕組み**: Rで学習したランダムフォレストモデルを使用して予測
- **特徴**:
  - 機械学習による予測
  - より高精度な予測が期待できる
  - R FastAPIサーバーが必要
- **使用ファイル**: `server_r_model.js` + `r_api/predict_api_fastapi.py`

**予測の流れ**:
1. 入力データを受け取る
2. R FastAPIサーバー（`http://localhost:5000`）に送信
3. Rモデルで予測を実行
4. 予測結果を返す

## 現在のデプロイ状況

現在デプロイされているのは **`server.js`（距離ベース予測）** です。

Rモデルを使用する場合は、以下の追加設定が必要です：

1. R FastAPIサーバーの起動
2. `server_r_model.js`を使用するように変更
3. Rモデルファイル（`.rds`ファイル）の配置

## 予測されるデータ

どちらの方法でも、以下の**退院時のFIMデータ**が予測されます：

### 運動機能項目（13項目）
- 食事、整容、清拭、更衣上半身、更衣下半身、トイレ動作、排尿管理、排便管理、ベッド移乗、トイレ移乗、浴槽移乗、歩行、階段

### 認知機能項目（5項目）
- 理解、表出、社会的交流、問題解決、記憶

### 合計値
- 運動機能合計（13項目の合計）
- 認知機能合計（5項目の合計）
- FIM総合計（18項目の合計）

## Rモデルを使用する場合のデプロイ

Rモデルを使用する場合は、以下の手順が必要です：

### 1. R FastAPIサーバーの起動

```bash
cd r_api
python predict_api_fastapi.py
```

### 2. Node.jsサーバーを`server_r_model.js`に変更

```bash
# PM2で再起動
pm2 delete fim-prediction
pm2 start server_r_model.js --name fim-prediction
pm2 save
```

または、`ecosystem.r.config.js`を使用：

```bash
pm2 start ecosystem.r.config.js
```

### 3. Rモデルファイルの確認

`r_api/r_models/`ディレクトリに以下のRモデルファイル（`.rds`）が必要です：

- `rf_model_all_FIM.rds` - 総合計予測モデル
- `rf_model_motor_FIM.rds` - 運動機能合計予測モデル
- `rf_model_cog_FIM.rds` - 認知機能合計予測モデル
- 各項目の予測モデル（食事、整容、清拭など）

## まとめ

- **現在**: 距離ベース予測（`server.js`）を使用
- **Rモデル**: `server_r_model.js`を使用することで有効化可能
- **予測内容**: どちらも退院時のFIMデータを予測

