# テストデータを使用した予測の確認方法

## 概要

テストデータの入院時データを入力して、Rモデルが正しく退院時のデータを予測できるか確認する方法です。

## 前提条件

1. Rモデルが学習・保存されている（`r_models/`ディレクトリに`.rds`ファイルが存在）
2. R FastAPIサーバーが起動している
3. Node.jsサーバーが起動している

## 確認手順

### ステップ1: Rの学習データの列名を確認

Rの学習データの列名を確認して、FastAPIのデータフレーム準備が正しいか確認します：

```r
# Rコンソールで実行
source("r_api/check_r_data_columns.R")
```

このスクリプトは以下を出力します：
- 学習データファイルの列名
- データの構造
- Python用の列名リスト

### ステップ2: FastAPIの列名を調整（必要に応じて）

`r_api/predict_api_fastapi.py`の`prepare_r_dataframe`関数で、Rの学習データの列名と一致させる必要があります。

Rの学習データの列名が異なる場合は、`prepare_r_dataframe`関数を修正してください。

### ステップ3: テスト予測の実行

Pythonスクリプトでテスト予測を実行：

```bash
cd r_api
python test_prediction.py
```

これにより、テストデータを使用して予測が実行され、結果が表示されます。

### ステップ4: Webアプリケーションでテスト

1. **フロントエンドを起動**
   ```bash
   npm run dev
   ```

2. **ブラウザで `http://localhost:5173` にアクセス**

3. **テストデータの値を入力**
   - データベースから実際のテストデータを取得
   - または、既知の入院時データを入力

4. **予測を実行**
   - 「予測」ボタンをクリック
   - 予測結果が表示されることを確認

5. **予測履歴を確認**
   ```bash
   npm run view-predictions
   ```

## テストデータの取得方法

### データベースから取得

```bash
npm run view-db
```

データベースから実際の患者データを確認し、その入院時データをフォームに入力して予測をテストできます。

### CSVファイルから取得

`テスト全データ.csv`からテストデータを取得：

```javascript
// ブラウザのコンソールで実行
const response = await fetch('/テスト全データ.csv');
const text = await response.text();
const lines = text.split('\n');
const headers = lines[0].split(',');
const testRow = lines[1].split(','); // 最初のデータ行

// データを確認
console.log('テストデータ:', testRow);
```

## 期待される動作

### 正常な場合

1. **入力**: テストデータの入院時FIM値と個人情報
2. **処理**: Rモデルによる予測
3. **出力**: 退院時FIM値の予測
   - 運動機能項目（13項目、階段を含む）
   - 認知機能項目（5項目）
   - 運動機能合計、認知機能合計、総合得点
4. **保存**: 入力データと予測結果がデータベースに保存される

### エラーが発生する場合

#### 列名の不一致エラー

**症状**: `予測エラー: 列名が見つかりません` などのエラー

**対処法**:
1. Rの学習データの列名を確認（`check_r_data_columns.R`を実行）
2. `prepare_r_dataframe`関数の列名を修正
3. Rモデルを再学習（必要に応じて）

#### Rモデルが読み込まれない

**症状**: `モデル xxx が読み込まれていません`

**対処法**:
1. Rモデルが`r_models/`ディレクトリに存在するか確認
2. `save_r_models.R`を実行してモデルを保存

#### R FastAPIに接続できない

**症状**: `R FastAPIが利用できません`

**対処法**:
1. R FastAPIサーバーが起動しているか確認
2. ポート5000が使用可能か確認
3. Rとrpy2が正しくインストールされているか確認

## 予測結果の検証

### 予測値の妥当性チェック

1. **範囲チェック**: FIM値は0-7の範囲内か
2. **合計値のチェック**: 個別項目の合計と合計値が一致するか
3. **傾向のチェック**: 入院時より退院時の方が高い値になっているか（一般的に）

### データベースへの保存確認

```bash
npm run view-predictions 10
```

最新10件の予測履歴が表示され、入力データと予測結果が正しく保存されているか確認できます。

## トラブルシューティング

### 予測結果がおかしい

1. **列名の確認**: Rの学習データの列名と一致しているか
2. **データの順序**: 項目の順序が正しいか
3. **データ型**: 数値が正しく変換されているか

### 予測が実行されない

1. **R FastAPIのログを確認**: エラーメッセージを確認
2. **モデルの読み込み状態を確認**: `/health`エンドポイントで確認
3. **入力データの形式を確認**: JSON形式が正しいか

## 次のステップ

予測が正常に動作することを確認したら：

1. ✅ テストデータでの動作確認
2. 🔄 実際のデータでの検証
3. 🔄 予測精度の評価
4. 🔄 ユーザーインターフェースの改善








