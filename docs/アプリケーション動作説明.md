# アプリケーション動作説明

## 現在の実装状況

現在のアプリケーションは、**距離ベースの予測アルゴリズム（k-NN的アプローチ）**を使用しています。

## システム構成

```
┌─────────────┐         ┌──────────────┐         ┌─────────────┐
│  ブラウザ   │ ──────> │  React App   │ ──────> │ Node.js API │
│  (ユーザー) │ <────── │  (フロント)  │ <────── │  (サーバー) │
└─────────────┘         └──────────────┘         └─────────────┘
                                                          │
                                                          ▼
                                                   ┌─────────────┐
                                                   │ SQLite DB   │
                                                   │ (患者データ)│
                                                   └─────────────┘
```

## 動作の流れ

### 1. アプリケーションの起動

#### フロントエンド（React）
```bash
npm run dev
```
- Vite開発サーバーが起動（通常は `http://localhost:5173`）
- Reactアプリケーションが表示される

#### バックエンド（Node.js）
```bash
npm run server
```
- Expressサーバーが起動（`http://localhost:3001`）
- SQLiteデータベースに接続

### 2. ユーザーがフォームに入力

**入力項目：**

1. **個人情報**
   - 性別（男性/女性）
   - 年齢
   - BMI
   - 要介護度の有無
   - 発症からの日数

2. **入院時FIM運動機能項目（12項目）**
   - 食事、整容、清拭、更衣上半身、更衣下半身
   - トイレ動作、排尿管理、排便管理
   - ベッド移乗、トイレ移乗、浴槽移乗、歩行

3. **入院時FIM認知機能項目（5項目）**
   - 理解、表出、社会的交流、問題解決、記憶

### 3. 予測APIの呼び出し

**フロントエンド（`src/pages/FormPage.jsx`）**
```javascript
// APIエンドポイント: /api/predict
const response = await fetch('/api/predict', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(inputData)
});
```

**バックエンド（`server.js`）の処理：**

#### ステップ1: 完全一致データの検索
```javascript
// 個人情報とFIM値が完全一致するデータを検索
SELECT * FROM patient_data 
WHERE gender = ? 
  AND ABS(age - ?) < 0.5
  AND ABS(bmi - ?) < 0.1
  AND care_level = ?
  AND ABS(days_from_onset - ?) < 0.5
```

- 完全一致が見つかった場合 → そのデータの退院時FIM値を返す

#### ステップ2: 最も近いデータの検索（完全一致がない場合）

距離計算のアルゴリズム：

```javascript
// 個人情報の距離
genderDiff = (性別が一致) ? 0 : 1
ageDiff = |年齢の差| / 100
bmiDiff = |BMIの差| / 10
careLevelDiff = (要介護度が一致) ? 0 : 1
daysDiff = |発症からの日数の差| / 100

// 運動機能項目の距離（12項目の平均）
motionDistance = Σ|入院時FIM値の差| / 12

// 認知機能項目の距離（5項目の平均）
cognitiveDistance = Σ|入院時FIM値の差| / 5

// 総合距離（重み付け）
totalDistance = 
  genderDiff * 0.05 +
  ageDiff * 0.05 +
  bmiDiff * 0.05 +
  careLevelDiff * 0.05 +
  daysDiff * 0.05 +
  motionDistance * 0.5 +      // 運動機能を重視
  cognitiveDistance * 0.25    // 認知機能を重視
```

- すべてのデータベースレコードを走査
- 総合距離が最小のデータを選択
- そのデータの退院時FIM値を予測値として返す

### 4. 予測結果の表示

**レスポンス形式：**
```json
{
  "motion": [5, 4, 3, ...],      // 運動機能項目の予測値（13項目）
  "cognitive": [6, 6, 5, ...],  // 認知機能項目の予測値（5項目）
  "motionTotal": 45,             // 運動機能合計
  "cognitiveTotal": 28,         // 認知機能合計
  "total": 73                    // 総合得点
}
```

**結果ページ（`src/pages/ResultPage.jsx`）で表示：**

1. **レーダーチャート**
   - 運動機能項目の入院時値 vs 予測値
   - 認知機能項目の入院時値 vs 予測値
   - Rechartsライブラリを使用

2. **合計点テーブル**
   - 入院時と予測値の比較
   - 運動機能合計、認知機能合計、総合得点

## データベース構造

**テーブル名：** `patient_data`

**カラム：**
- `id` - 主キー
- `gender` - 性別（0: 男性、1: 女性）
- `age` - 年齢
- `bmi` - BMI
- `care_level` - 要介護度（0: 無、1: 有）
- `days_from_onset` - 発症からの日数
- `admission_motion` - 入院時FIM運動機能項目（JSON配列）
- `admission_cognitive` - 入院時FIM認知機能項目（JSON配列）
- `admission_motion_total` - 入院時運動機能合計
- `admission_cognitive_total` - 入院時認知機能合計
- `admission_total` - 入院時総合得点
- `discharge_motion` - 退院時FIM運動機能項目（JSON配列）
- `discharge_cognitive` - 退院時FIM認知機能項目（JSON配列）
- `discharge_motion_total` - 退院時運動機能合計
- `discharge_cognitive_total` - 退院時認知機能合計
- `discharge_total` - 退院時総合得点

## 現在の予測アルゴリズムの特徴

### ✅ メリット
- 実装がシンプル
- データベースから直接検索できる
- 追加の機械学習ライブラリが不要

### ⚠️ 制限事項
- データベースに類似データがない場合、精度が低下する可能性
- 機械学習モデル（ランダムフォレスト）と比較して精度が低い可能性
- 新しいパターンに対応しにくい

## 今後の改善案

現在、**R FastAPI**を使用した機械学習モデルの実装が準備されています：

- `r_api/predict_api_fastapi.py` - FastAPIサーバー（Rモデルを使用）
- `server_with_r_fastapi.js` - R FastAPIを使用するNode.jsサーバー

R FastAPIを有効化すると：
- ✅ ランダムフォレストモデルによる高精度な予測
- ✅ データベースにないパターンにも対応可能
- ✅ 機械学習による汎化性能

## APIエンドポイント

### POST /api/predict

**リクエスト：**
```json
{
  "gender": "male",
  "age": 65,
  "bmi": 23.5,
  "careLevel": "no",
  "daysFromOnset": 30,
  "motionValues": {
    "食事": 5,
    "整容": 4,
    ...
  },
  "cognitiveValues": {
    "理解": 6,
    "表出": 6,
    ...
  }
}
```

**レスポンス：**
```json
{
  "motion": [5, 4, 3, ...],
  "cognitive": [6, 6, 5, ...],
  "motionTotal": 45,
  "cognitiveTotal": 28,
  "total": 73
}
```

### GET /api/data

データベースのデータを確認（開発用）

### GET /api/stats

データベースの統計情報を取得

## 開発環境のセットアップ

1. **依存関係のインストール**
   ```bash
   npm install
   ```

2. **データベースの初期化**
   ```bash
   npm run init-db
   ```

3. **サーバーの起動**
   ```bash
   # バックエンド
   npm run server
   
   # フロントエンド（別ターミナル）
   npm run dev
   ```

## トラブルシューティング

### APIエラーが発生する場合

1. サーバーが起動しているか確認
2. データベースが正しく初期化されているか確認
   ```bash
   npm run view-db
   ```
3. ブラウザのコンソールでエラーメッセージを確認

### 予測結果が表示されない場合

1. 入力データが正しい形式か確認
2. データベースに類似データが存在するか確認
3. ネットワークタブでAPIレスポンスを確認

