FIM予測モデル - 動作説明書
========================================

【概要】
この予測モデルは、R言語とランダムフォレスト（Random Forest）アルゴリズムを使用して、
患者の退院時FIM（Functional Independence Measure：機能的自立度評価）スコアを予測する
機械学習システムです。

【処理の流れ】

1. データの前処理
   - CSVファイル（alldata_305.csv）からデータを読み込む
   - 欠損値（NA）を含む行を削除してクリーンなデータセットを作成
   - 304名のデータを学習データ（213名、70%）とテストデータ（91名、30%）にランダム分割
   - データの文字化けを防ぐため、CP932エンコーディングで保存

2. 機械学習モデルの構築
   - ランダムフォレスト（rf）アルゴリズムを使用
   - 交差検証（Cross-Validation）を実施：
     * 10分割交差検証を3回繰り返し（repeatedcv）
     * 合計30回の検証でモデルの汎化性能を評価
   - 各FIM項目ごとに個別の予測モデルを構築

3. 予測対象となるFIM項目
   以下の各項目について、退院時のスコアを予測するモデルを構築：

   【総合スコア】
   - 退院時FIM総得点

   【カテゴリ別スコア】
   - 退院時FIM運動項目合計
   - 退院時FIM認知項目合計

   【運動機能項目（12項目）】
   - 退院時FIM食事
   - 退院時FIM整容
   - 退院時FIM清拭
   - 退院時FIM更衣上半身
   - 退院時FIM更衣下半身
   - 退院時FIMトイレ動作
   - 退院時FIM排尿管理
   - 退院時FIM排便管理
   - 退院時FIMベッド移乗
   - 退院時FIMトイレ移乗
   - 退院時FIM浴槽移乗
   - 退院時FIM歩行
   - 退院時FIM階段

   【認知機能項目（5項目）】
   - 退院時FIM理解
   - 退院時FIM表出
   - 退院時FIM社会的交流
   - 退院時FIM問題解決
   - 退院時FIM記憶

4. 各モデルの処理ステップ
   各FIM項目について、以下の順序で処理を実行：

   (1) 学習データの読み込みと確認
       - CSVファイルから学習データを読み込む
       - データの構造と統計情報を確認

   (2) モデルの学習
       - 入院時のFIM値や患者の基本情報（性別、年齢、BMI、要介護度、発症からの日数など）
         を説明変数として使用
       - 退院時のFIM値を目的変数として予測モデルを構築

   (3) モデルの評価
       - 学習データでのモデル性能を確認
       - 最適なハイパーパラメータを選択

   (4) 変数重要度の分析
       - どの説明変数が予測に重要かを分析
       - 重要度の数値をCSVファイルに出力

   (5) テストデータでの予測
       - 学習済みモデルを使用してテストデータの退院時FIM値を予測
       - 予測精度を以下の指標で評価：
         * RMSE（Root Mean Squared Error：平均二乗誤差平方根）
         * MAE（Mean Absolute Error：平均絶対誤差）
         * R2（決定係数：予測の精度を示す指標）

   (6) 予測結果の保存
       - 予測値をCSVファイルに出力

   (7) 誤差の計算
       - 学習データとテストデータそれぞれで中央値絶対誤差（MedAE）を計算
       - モデルの予測精度を評価

【予測に使用される入力データ】
- 性別（gender）
- 年齢（age）
- BMI（Body Mass Index）
- 要介護度の有無（care_level）
- 発症からの日数（days_from_onset）
- 入院時のFIM各項目のスコア
  * 運動機能項目（12項目）
  * 認知機能項目（5項目）

【出力される結果】
- 各FIM項目の退院時予測スコア
- 予測精度の評価指標（RMSE、MAE、R2）
- 変数重要度のデータ
- 予測値と実測値の比較データ

【モデルの特徴】
- ランダムフォレストは複数の決定木を組み合わせたアンサンブル学習手法
- 過学習に強く、非線形な関係も捉えられる
- 変数重要度を自動的に評価できる
- 交差検証により、モデルの汎化性能を高く保つ

【注意事項】
- データはCP932エンコーディングで保存されるため、日本語の文字化けを防ぐ
- 各モデルは独立して学習されるため、項目間の相関は考慮されない
- 予測精度は学習データとテストデータの分布に依存する

