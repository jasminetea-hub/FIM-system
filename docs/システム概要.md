# システム概要

## 1. システムの目的

本システムは、リハビリテーション患者の退院時のFIM（Functional Independence Measure：機能的自立度評価法）値を予測するWebアプリケーションである。入院時の患者情報とFIM値を入力することで、機械学習モデルを用いて退院時のFIM値を予測し、リハビリテーション計画の立案や予後予測に活用することを目的とする。

## 2. システム構成

### 2.1 アーキテクチャ

本システムは、以下の3層アーキテクチャで構成されている。

```
┌─────────────────┐
│   フロントエンド │
│   (React + Vite) │
│   Port: 5173     │
└────────┬────────┘
         │ HTTP/JSON
         ▼
┌─────────────────┐
│   バックエンド   │
│ (Node.js/Express)│
│   Port: 3001     │
└────────┬────────┘
         │ HTTP/JSON
         ▼
┌─────────────────┐
│ 機械学習API      │
│ (FastAPI + R)    │
│   Port: 5000     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Rモデル         │
│ (.rdsファイル)   │
└─────────────────┘
```

### 2.2 技術スタック

#### フロントエンド
- **React 19.2.0**: UI構築のためのJavaScriptライブラリ
- **Vite 7.2.6**: 高速な開発サーバーとビルドツール
- **React Router DOM 7.10.1**: ルーティング管理
- **Recharts 3.5.1**: データ可視化（レーダーチャート）用ライブラリ

#### バックエンド
- **Node.js**: JavaScript実行環境
- **Express 5.2.1**: Webアプリケーションフレームワーク

#### 機械学習
- **Python**: 機械学習APIの実装言語
- **FastAPI**: 高性能なWeb APIフレームワーク
- **R言語**: 機械学習モデルの学習・実行環境
- **rpy2**: PythonからRを呼び出すためのライブラリ
- **ランダムフォレスト**: 予測に使用する機械学習アルゴリズム

## 3. システム機能

### 3.1 入力機能

ユーザーは以下の情報を入力する：

1. **個人情報**
   - 性別（男性/女性）
   - 年齢
   - BMI（Body Mass Index）
   - 要介護度の有無
   - 発症から入棟までの日数

2. **入院時FIM運動機能項目（12項目）**
   - 食事、整容、清拭、更衣上半身、更衣下半身
   - トイレ動作、排尿管理、排便管理
   - ベッド移乗、トイレ移乗、浴槽移乗、歩行
   - 各項目は1〜7の7段階評価

3. **入院時FIM認知機能項目（5項目）**
   - 理解、表出、社会的交流、問題解決、記憶
   - 各項目は1〜7の7段階評価

### 3.2 予測機能

入力されたデータを基に、以下の予測を実行する：

1. **運動機能項目の予測（12項目）**
   - 各項目ごとに個別のランダムフォレストモデルを使用
   - 予測値は0〜7の範囲に制限

2. **認知機能項目の予測（5項目）**
   - 各項目ごとに個別のランダムフォレストモデルを使用
   - 予測値は0〜7の範囲に制限

3. **合計値の予測**
   - 運動機能合計、認知機能合計、総合得点
   - 専用のモデルを使用、または個別予測値の合計

### 3.3 結果表示機能

予測結果は以下の形式で表示される：

1. **レーダーチャート**
   - 運動機能項目：入院時値と予測値の比較
   - 認知機能項目：入院時値と予測値の比較
   - 視覚的に改善傾向を確認可能

2. **合計点テーブル**
   - 入院時と予測値の比較
   - 運動機能合計、認知機能合計、総合得点を表示

## 4. データフロー

### 4.1 予測処理の流れ

1. **ユーザー入力**（フロントエンド）
   - フォームに入力データを入力
   - バリデーション（必須項目、数値範囲のチェック）

2. **APIリクエスト送信**（フロントエンド → バックエンド）
   - `POST /api/predict` エンドポイントに送信
   - JSON形式で入力データを送信

3. **R FastAPIへの転送**（バックエンド → 機械学習API）
   - バックエンドがR FastAPIサーバーに予測リクエストを転送
   - `POST http://localhost:5000/predict` に送信

4. **予測実行**（機械学習API）
   - 入力データをRのデータフレーム形式に変換
   - 各項目のランダムフォレストモデルで予測を実行
   - 予測結果をJSON形式で返却

5. **結果表示**（フロントエンド）
   - 予測結果をレーダーチャートとテーブルで表示
   - 入院時値と予測値を比較表示

### 4.2 データ形式

#### リクエスト（POST /api/predict）
```json
{
  "gender": "male",
  "age": 65,
  "bmi": 23.5,
  "careLevel": "no",
  "daysFromOnset": 30,
  "motionValues": {
    "食事": 5,
    "整容": 4,
    ...
  },
  "cognitiveValues": {
    "理解": 6,
    "表出": 6,
    ...
  }
}
```

#### レスポンス
```json
{
  "motion": [5.2, 4.8, 3.5, ...],
  "cognitive": [6.1, 6.0, 5.8, ...],
  "motionTotal": 45.3,
  "cognitiveTotal": 28.7,
  "total": 74.0
}
```

## 5. 機械学習モデル

### 5.1 モデルの種類

本システムでは、以下の19個のランダムフォレストモデルを使用する：

- **総合予測モデル（1個）**: 総合得点の予測
- **運動機能合計モデル（1個）**: 運動機能合計の予測
- **認知機能合計モデル（1個）**: 認知機能合計の予測
- **運動機能項目モデル（12個）**: 各運動機能項目の個別予測
- **認知機能項目モデル（5個）**: 各認知機能項目の個別予測

### 5.2 モデルの特徴

- **アルゴリズム**: ランダムフォレスト（Random Forest）
- **実装**: R言語の`caret`パッケージを使用
- **モデルファイル形式**: `.rds`形式（Rのシリアライズ形式）
- **予測範囲**: FIMスコアは0〜7の範囲に制限

### 5.3 モデルの読み込み

- アプリケーション起動時にすべてのモデルをメモリに読み込み
- 予測リクエストごとにモデルを再読み込みする必要がなく、高速な予測が可能

## 6. セキュリティとパフォーマンス

### 6.1 セキュリティ対策

- **CORS設定**: クロスオリジンリソース共有の適切な設定
- **入力検証**: フロントエンドとバックエンドの両方で入力データの検証
- **エラーハンドリング**: 適切なエラーメッセージとステータスコードの返却

### 6.2 パフォーマンス

- **モデルの事前読み込み**: 起動時にモデルを読み込み、予測時のオーバーヘッドを削減
- **非同期処理**: Node.jsの非同期処理により、複数のリクエストを効率的に処理
- **レスポンス時間**: 通常、予測処理は数秒以内に完了

## 7. デプロイメント

### 7.1 開発環境

- フロントエンド: Vite開発サーバー（`npm run dev`）
- バックエンド: Node.jsサーバー（`npm run server`）
- 機械学習API: FastAPIサーバー（`python predict_api_fastapi.py`）

### 7.2 本番環境

- **ビルド**: フロントエンドを`npm run build`でビルド
- **サーバー**: Node.jsサーバーが静的ファイルとAPIの両方を提供
- **プロセス管理**: PM2を使用したプロセス管理（推奨）
- **デプロイ先**: VPS（さくらのVPSなど）へのデプロイに対応

## 8. システムの特徴と利点

### 8.1 特徴

1. **機械学習による高精度な予測**: ランダムフォレストモデルによる高精度な予測
2. **項目ごとの個別予測**: 各FIM項目ごとに最適化されたモデルを使用
3. **視覚的な結果表示**: レーダーチャートによる直感的な結果表示

### 8.2 利点

1. **リハビリテーション計画の支援**: 退院時のFIM値を予測することで、適切なリハビリテーション計画の立案が可能
2. **予後予測の精度向上**: 機械学習モデルによる客観的な予測
3. **使いやすいインターフェース**: 直感的なWebインターフェースにより、医療従事者が容易に利用可能

## 9. 今後の拡張可能性

- **モデルの再学習**: 新しいデータが蓄積された際のモデルの再学習機能
- **予測精度の向上**: より高度な機械学習アルゴリズムの導入
- **多変量解析**: より多くの変数を考慮した予測モデルの構築
- **レポート機能**: 予測結果の詳細レポート生成機能
- **ユーザー管理**: 複数のユーザーによる利用を想定した認証機能
