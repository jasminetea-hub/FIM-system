# さくらのインターネットへのデプロイ手順

このドキュメントでは、FIM予測システムをさくらのインターネットのサーバーにデプロイする手順を説明します。

## 前提条件

- さくらのレンタルサーバー（スタンダードプラン以上）またはVPS
- Node.jsが利用可能（レンタルサーバーの場合はスタンダードプラン以上が必要）
- SSHアクセス権限
- FTP/SFTPクライアント（FileZilla、WinSCPなど）

## デプロイ方法の選択

### 方法A: GitHub経由でデプロイ（推奨）

GitHubリポジトリから`git clone`してデプロイする方法です。
更新時も`git pull`で簡単に更新できます。

**詳細は [`docs/GitHub経由デプロイ手順.md`](GitHub経由デプロイ手順.md) を参照してください。**

### 方法B: FTP/SFTPで直接アップロード

FTP/SFTPクライアントを使用してファイルを直接アップロードする方法です。

### 予測方法の選択

#### 方法1: 距離ベース予測のみを使用する場合（推奨・簡単）

Rモデルを使用せず、データベースの距離ベース予測のみを使用する方法です。
この方法は、Node.jsとSQLiteのみで動作するため、最も簡単にデプロイできます。

#### 方法2: Rモデルを使用する場合（高度）

Rモデルを使用する場合は、Python、R、rpy2のセットアップが必要です。
さくらのレンタルサーバーでは、Rのインストールが難しい場合があります。
VPSを使用することを推奨します。

---

## 方法1: 距離ベース予測のみを使用する場合

### ステップ1: ローカルでビルド

まず、ローカル環境でフロントエンドをビルドします：

```bash
# 依存関係のインストール（まだの場合）
npm install

# フロントエンドをビルド
npm run build
```

これにより、`dist/`ディレクトリにビルド済みのファイルが生成されます。

### ステップ2: サーバーにファイルをアップロード

以下のファイルとディレクトリをサーバーにアップロードします：

**必須ファイル:**
- `server.js` - Expressサーバー
- `package.json` - 依存関係定義
- `package-lock.json` - 依存関係のロックファイル
- `database.db` - SQLiteデータベース（または空のデータベース）
- `dist/` - ビルド済みフロントエンド（ディレクトリごと）
- `public/` - 静的ファイル（ディレクトリごと）
- `scripts/` - スクリプトディレクトリ（ディレクトリごと）

**アップロード先:**
さくらのレンタルサーバーの場合、通常は以下のディレクトリにアップロードします：
- `/home/[ユーザー名]/[ドメイン名]/` または
- `/home/[ユーザー名]/www/[ドメイン名]/`

### ステップ3: サーバーでNode.jsのセットアップ

SSHでサーバーに接続し、以下のコマンドを実行します：

```bash
# アップロードしたディレクトリに移動
cd /home/[ユーザー名]/[ドメイン名]/

# Node.jsのバージョンを確認
node --version
npm --version

# 依存関係をインストール
npm install --production
```

### ステップ4: データベースの初期化（初回のみ）

データベースがまだ初期化されていない場合：

```bash
# データベースを初期化
npm run init-db
```

### ステップ5: サーバーの起動設定

さくらのレンタルサーバーでは、Node.jsアプリケーションを常時起動させるために、以下の方法があります：

#### 5-1. PM2を使用する方法（推奨）

**方法A: 設定ファイルを使用（推奨）**

```bash
# PM2をグローバルにインストール
npm install -g pm2

# ログディレクトリを作成
mkdir -p logs

# 設定ファイルを使用して起動
pm2 start ecosystem.config.js

# 自動起動を設定
pm2 startup
pm2 save
```

**方法B: コマンドラインから直接起動**

```bash
# PM2をグローバルにインストール
npm install -g pm2

# アプリケーションを起動
pm2 start server.js --name fim-prediction

# 自動起動を設定
pm2 startup
pm2 save
```

**PM2の便利なコマンド:**

```bash
# ステータス確認
pm2 status

# ログ確認
pm2 logs fim-prediction

# 再起動
pm2 restart fim-prediction

# 停止
pm2 stop fim-prediction

# 削除
pm2 delete fim-prediction
```

#### 5-2. systemdサービスとして設定する方法

`/etc/systemd/system/fim-prediction.service` を作成：

```ini
[Unit]
Description=FIM Prediction System
After=network.target

[Service]
Type=simple
User=[ユーザー名]
WorkingDirectory=/home/[ユーザー名]/[ドメイン名]
ExecStart=/usr/bin/node server.js
Restart=always
RestartSec=10
Environment=NODE_ENV=production
Environment=PORT=3001

[Install]
WantedBy=multi-user.target
```

サービスを有効化：

```bash
sudo systemctl daemon-reload
sudo systemctl enable fim-prediction
sudo systemctl start fim-prediction
```

### ステップ6: リバースプロキシの設定

さくらのレンタルサーバーでは、通常ポート3001を直接公開できません。
`.htaccess`ファイルまたはWebサーバーの設定でリバースプロキシを設定します。

#### Apacheの場合（.htaccess）

アップロードしたディレクトリに`.htaccess`ファイルを作成：

```apache
RewriteEngine On
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^api/(.*)$ http://localhost:3001/api/$1 [P,L]
RewriteRule ^(.*)$ http://localhost:3001/$1 [P,L]
```

または、mod_proxyを使用する場合：

```apache
<IfModule mod_proxy.c>
    ProxyPreserveHost On
    ProxyPass /api http://localhost:3001/api
    ProxyPassReverse /api http://localhost:3001/api
    ProxyPass / http://localhost:3001/
    ProxyPassReverse / http://localhost:3001/
</IfModule>
```

#### Nginxの場合

Nginxの設定ファイルに追加：

```nginx
location / {
    proxy_pass http://localhost:3001;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
}

location /api {
    proxy_pass http://localhost:3001/api;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
}
```

### ステップ7: ポート番号の確認と設定

`server.js`では、環境変数`PORT`でポート番号を設定できます。
さくらのレンタルサーバーでは、通常3001番ポートを使用します。

環境変数を設定する場合：

```bash
# .envファイルを作成（オプション）
echo "PORT=3001" > .env
```

または、PM2を使用する場合：

```bash
pm2 start server.js --name fim-prediction --update-env --env production
```

### ステップ8: 動作確認

1. ブラウザで `http://[あなたのドメイン]/` にアクセス
2. フォームに入力して予測を実行
3. 予測結果が表示されることを確認

---

## 方法2: Rモデルを使用する場合

### 追加の前提条件

- Python 3.8以上
- R（CRANからインストール）
- rpy2（Pythonパッケージ）

### 追加のセットアップ手順

#### 1. Python環境のセットアップ

```bash
# Pythonのバージョン確認
python3 --version

# 仮想環境を作成（推奨）
python3 -m venv venv
source venv/bin/activate  # Linuxの場合
# または
venv\Scripts\activate  # Windowsの場合

# 依存関係をインストール
cd r_api
pip install -r requirements.txt
```

#### 2. Rのインストールとセットアップ

```bash
# Rのインストール（さくらのレンタルサーバーでは難しい場合があります）
# VPSを使用することを推奨します

# Rパッケージのインストール
Rscript r_api/install_r_packages.R

# Rモデルの学習・保存
Rscript r_api/save_r_models.R
```

#### 3. R FastAPIサーバーの起動

```bash
cd r_api
python predict_api_fastapi.py
```

#### 4. Node.jsサーバーの起動

`server_r_model.js`を使用します：

```bash
# PM2で起動
pm2 start server_r_model.js --name fim-prediction-r

# または直接起動
node server_r_model.js
```

---

## トラブルシューティング

### ポートが使用できない

さくらのレンタルサーバーでは、特定のポートのみ使用可能な場合があります。
`.htaccess`やNginxの設定でリバースプロキシを使用してください。

### データベースの権限エラー

SQLiteデータベースファイルに書き込み権限が必要です：

```bash
chmod 664 database.db
chmod 755 .
```

### Node.jsのバージョンが古い

さくらのレンタルサーバーでは、Node.jsのバージョンが古い場合があります。
必要に応じて、nvmを使用してNode.jsをアップグレードしてください。

### 静的ファイルが表示されない

`dist/`ディレクトリが正しくアップロードされているか確認してください。
また、`server.js`が静的ファイルを正しく配信しているか確認してください。

### CORSエラー

本番環境では、CORSの設定を適切に制限してください：

```javascript
// server.js
app.use(cors({
  origin: 'https://[あなたのドメイン]',
  credentials: true
}));
```

---

## セキュリティの推奨事項

1. **環境変数の使用**: 機密情報は環境変数に保存
2. **HTTPSの使用**: SSL証明書を設定してHTTPSを使用
3. **CORSの制限**: 本番環境では適切なオリジンのみ許可
4. **データベースのバックアップ**: 定期的に`database.db`をバックアップ
5. **ログの監視**: エラーログを定期的に確認

---

## 更新手順

アプリケーションを更新する場合：

```bash
# 1. ローカルで変更をビルド
npm run build

# 2. 変更したファイルをサーバーにアップロード
# - dist/ ディレクトリ
# - 変更したソースファイル

# 3. サーバーで依存関係を更新（必要に応じて）
npm install --production

# 4. サーバーを再起動
pm2 restart fim-prediction
# または
systemctl restart fim-prediction
```

---

## 参考リンク

- [さくらのレンタルサーバー マニュアル](https://manual.sakura.ad.jp/)
- [Node.js公式サイト](https://nodejs.org/)
- [PM2公式ドキュメント](https://pm2.keymetrics.io/docs/usage/quick-start/)

