# さくらのインターネットへのデプロイ手順

このドキュメントでは、FIM 予測システムをさくらのインターネットのサーバーにデプロイする手順を説明します。

## 前提条件

- さくらのレンタルサーバー（スタンダードプラン以上）または VPS
- Node.js が利用可能（レンタルサーバーの場合はスタンダードプラン以上が必要）
- SSH アクセス権限
- FTP/SFTP クライアント（FileZilla、WinSCP など）

## デプロイ方法の選択

### 方法 A: GitHub 経由でデプロイ（推奨）

GitHub リポジトリから`git clone`してデプロイする方法です。
更新時も`git pull`で簡単に更新できます。

**詳細は [`docs/GitHub経由デプロイ手順.md`](GitHub経由デプロイ手順.md) を参照してください。**

### 方法 B: FTP/SFTP で直接アップロード

FTP/SFTP クライアントを使用してファイルを直接アップロードする方法です。

---

## R モデルを使用したデプロイ手順

このシステムは R モデルを使用して予測を行います。
Python、R、rpy2 のセットアップが必要です。
さくらのレンタルサーバーでは、R のインストールが難しい場合があります。
VPS を使用することを推奨します。

### ステップ 1: ローカルでビルド

まず、ローカル環境でフロントエンドをビルドします：

```bash
# 依存関係のインストール（まだの場合）
npm install

# フロントエンドをビルド
npm run build
```

これにより、`dist/`ディレクトリにビルド済みのファイルが生成されます。

### ステップ 2: サーバーにファイルをアップロード

以下のファイルとディレクトリをサーバーにアップロードします：

**必須ファイル:**

- `server_r_model.js` - Express サーバー（Rモデル使用）
- `package.json` - 依存関係定義
- `package-lock.json` - 依存関係のロックファイル
- `ecosystem.r.config.js` - PM2設定ファイル
- `database.db` - SQLite データベース（または空のデータベース）
- `dist/` - ビルド済みフロントエンド（ディレクトリごと）
- `public/` - 静的ファイル（ディレクトリごと）
- `scripts/` - スクリプトディレクトリ（ディレクトリごと）
- `r_api/` - R FastAPI関連（ディレクトリごと）

**アップロード先:**
さくらのレンタルサーバーの場合、通常は以下のディレクトリにアップロードします：

- `/home/[ユーザー名]/[ドメイン名]/` または
- `/home/[ユーザー名]/www/[ドメイン名]/`

### ステップ 3: サーバーで Node.js のセットアップ

SSH でサーバーに接続し、以下のコマンドを実行します：

```bash
# アップロードしたディレクトリに移動
cd /home/[ユーザー名]/[ドメイン名]/

# Node.jsのバージョンを確認
node --version
npm --version

# 依存関係をインストール
npm install --production
```

### ステップ 4: データベースの初期化（初回のみ）

データベースがまだ初期化されていない場合：

```bash
# データベースを初期化
npm run init-db
```

### ステップ 5: R 環境のセットアップ

#### 5-1. Python 環境のセットアップ

```bash
# Pythonのバージョン確認
python3 --version

# 仮想環境を作成（推奨）
python3 -m venv venv
source venv/bin/activate  # Linuxの場合

# 依存関係をインストール
cd r_api
pip install -r requirements.txt
```

#### 5-2. R のインストールとセットアップ

```bash
# Rのインストール（さくらのレンタルサーバーでは難しい場合があります）
# VPSを使用することを推奨します

# Rパッケージのインストール
Rscript r_api/install_r_packages.R

# Rモデルの学習・保存
Rscript r_api/save_r_models.R
```

### ステップ 6: サーバーの起動設定

さくらのレンタルサーバーでは、Node.js アプリケーションを常時起動させるために、以下の方法があります：

#### 6-1. PM2 を使用する方法（推奨）

```bash
# PM2をグローバルにインストール
npm install -g pm2

# ログディレクトリを作成
mkdir -p logs

# アプリケーションを起動（R FastAPIとNode.jsサーバーの両方）
pm2 start ecosystem.r.config.js

# 自動起動を設定
pm2 startup
pm2 save
```

**PM2 の便利なコマンド:**

```bash
# ステータス確認
pm2 status

# ログ確認
pm2 logs fim-prediction-r
pm2 logs r-api-server

# 再起動
pm2 restart all

# 停止
pm2 stop all

# 削除
pm2 delete all
```

#### 6-2. systemd サービスとして設定する方法

`/etc/systemd/system/fim-prediction.service` を作成：

```ini
[Unit]
Description=FIM Prediction System
After=network.target

[Service]
Type=simple
User=[ユーザー名]
WorkingDirectory=/home/[ユーザー名]/[ドメイン名]
ExecStart=/usr/bin/node server_r_model.js
Restart=always
RestartSec=10
Environment=NODE_ENV=production
Environment=PORT=3001

[Install]
WantedBy=multi-user.target
```

サービスを有効化：

```bash
sudo systemctl daemon-reload
sudo systemctl enable fim-prediction
sudo systemctl start fim-prediction
```

### ステップ 7: リバースプロキシの設定

さくらのレンタルサーバーでは、通常ポート 3001 を直接公開できません。
`.htaccess`ファイルまたは Web サーバーの設定でリバースプロキシを設定します。

#### Apache の場合（.htaccess）

アップロードしたディレクトリに`.htaccess`ファイルを作成：

```apache
RewriteEngine On
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^api/(.*)$ http://localhost:3001/api/$1 [P,L]
RewriteRule ^(.*)$ http://localhost:3001/$1 [P,L]
```

または、mod_proxy を使用する場合：

```apache
<IfModule mod_proxy.c>
    ProxyPreserveHost On
    ProxyPass /api http://localhost:3001/api
    ProxyPassReverse /api http://localhost:3001/api
    ProxyPass / http://localhost:3001/
    ProxyPassReverse / http://localhost:3001/
</IfModule>
```

#### Nginx の場合

Nginx の設定ファイルに追加：

```nginx
location / {
    proxy_pass http://localhost:3001;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
}

location /api {
    proxy_pass http://localhost:3001/api;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
}
```

### ステップ 8: ポート番号の確認と設定

`server_r_model.js`では、環境変数`PORT`でポート番号を設定できます。
さくらのレンタルサーバーでは、通常 3001 番ポートを使用します。

環境変数を設定する場合：

```bash
# .envファイルを作成（オプション）
echo "PORT=3001" > .env
```

または、PM2 を使用する場合：

```bash
pm2 start ecosystem.r.config.js
```

### ステップ 9: 動作確認

1. ブラウザで `http://[あなたのドメイン]/` にアクセス
2. フォームに入力して予測を実行
3. 予測結果が表示されることを確認

---

## 追加のセットアップ手順

---

## トラブルシューティング

### ポートが使用できない

さくらのレンタルサーバーでは、特定のポートのみ使用可能な場合があります。
`.htaccess`や Nginx の設定でリバースプロキシを使用してください。

### データベースの権限エラー

SQLite データベースファイルに書き込み権限が必要です：

```bash
chmod 664 database.db
chmod 755 .
```

### Node.js のバージョンが古い

さくらのレンタルサーバーでは、Node.js のバージョンが古い場合があります。
必要に応じて、nvm を使用して Node.js をアップグレードしてください。

### 静的ファイルが表示されない

`dist/`ディレクトリが正しくアップロードされているか確認してください。
また、`server_r_model.js`が静的ファイルを正しく配信しているか確認してください。

### CORS エラー

本番環境では、CORS の設定を適切に制限してください：

```javascript
// server_r_model.js
app.use(
  cors({
    origin: 'https://[あなたのドメイン]',
    credentials: true,
  })
);
```

---

## セキュリティの推奨事項

1. **環境変数の使用**: 機密情報は環境変数に保存
2. **HTTPS の使用**: SSL 証明書を設定して HTTPS を使用
3. **CORS の制限**: 本番環境では適切なオリジンのみ許可
4. **データベースのバックアップ**: 定期的に`database.db`をバックアップ
5. **ログの監視**: エラーログを定期的に確認

---

## 更新手順

アプリケーションを更新する場合：

```bash
# 1. ローカルで変更をビルド
npm run build

# 2. 変更したファイルをサーバーにアップロード
# - dist/ ディレクトリ
# - 変更したソースファイル

# 3. サーバーで依存関係を更新（必要に応じて）
npm install --production

# 4. サーバーを再起動
pm2 restart fim-prediction-r
# または
systemctl restart fim-prediction
```

---

## 参考リンク

- [さくらのレンタルサーバー マニュアル](https://manual.sakura.ad.jp/)
- [Node.js 公式サイト](https://nodejs.org/)
- [PM2 公式ドキュメント](https://pm2.keymetrics.io/docs/usage/quick-start/)
