# システム構成

## 1. システムアーキテクチャ

本システムは、3層アーキテクチャを採用したWebアプリケーションとして実装されている。各層は独立して動作し、HTTP/JSONプロトコルを通じて通信を行う。この構成により、各層の役割を明確に分離し、保守性と拡張性を確保している。

### 1.1 アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────┐
│                    プレゼンテーション層                    │
│  ┌──────────────────────────────────────────────────┐  │
│  │  フロントエンド（React + Vite）                    │  │
│  │  - ユーザーインターフェース                       │  │
│  │  - 入力フォーム（個人情報、FIM値）                 │  │
│  │  - 結果表示（レーダーチャート、テーブル）          │  │
│  │  Port: 5173（開発環境）                          │  │
│  └──────────────────────────────────────────────────┘  │
└───────────────────────┬─────────────────────────────────┘
                        │ HTTP/JSON (REST API)
                        ▼
┌─────────────────────────────────────────────────────────┐
│                      アプリケーション層                   │
│  ┌──────────────────────────────────────────────────┐  │
│  │  バックエンド（Node.js + Express）                │  │
│  │  - APIエンドポイント提供                         │  │
│  │  - リクエストのルーティング                       │  │
│  │  - データベース操作（SQLite）                    │  │
│  │  - 予測履歴の保存・取得                           │  │
│  │  Port: 3001                                      │  │
│  └───────────────────────┬──────────────────────────┘  │
└───────────────────────────┼─────────────────────────────┘
                            │ HTTP/JSON
                            ▼
┌─────────────────────────────────────────────────────────┐
│                      機械学習層                          │
│  ┌──────────────────────────────────────────────────┐  │
│  │  機械学習API（FastAPI + Python + R）             │  │
│  │  - Rモデルの読み込み・管理                        │  │
│  │  - 予測処理の実行                                 │  │
│  │  - データ形式の変換（JSON ↔ R DataFrame）        │  │
│  │  Port: 5000                                      │  │
│  └───────────────────────┬──────────────────────────┘  │
└───────────────────────────┼─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                      データ層                            │
│  ┌──────────────────────┐  ┌──────────────────────┐  │
│  │  R機械学習モデル      │  │  SQLiteデータベース   │  │
│  │  (.rdsファイル)       │  │  (予測履歴、患者データ)│  │
│  │  - 19個のモデル       │  │  - prediction_history│  │
│  │  - ランダムフォレスト │  │  - patient_data      │  │
│  └──────────────────────┘  └──────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 1.2 各層の役割

#### プレゼンテーション層（フロントエンド）

フロントエンドは、ユーザーとの対話を担当する層である。React 19.2.0とVite 7.2.6を使用して実装されており、以下の機能を提供する。

- **入力フォーム**: 個人情報（性別、年齢、BMI、要介護度、発症から入棟までの日数）および入院時FIM値（運動機能12項目、認知機能5項目）の入力
- **バリデーション**: 入力データの妥当性検証（必須項目チェック、数値範囲チェック）
- **結果表示**: 予測結果をレーダーチャートとテーブル形式で視覚的に表示
- **ルーティング**: React Router DOM 7.10.1によるページ遷移管理

#### アプリケーション層（バックエンド）

バックエンドは、ビジネスロジックとデータ管理を担当する層である。Node.jsとExpress 5.2.1を使用して実装されており、以下の機能を提供する。

- **APIエンドポイント**: RESTful APIの提供（`POST /api/predict`、`GET /api/predictions`など）
- **リクエスト処理**: フロントエンドからのリクエストを受け取り、機械学習APIに転送
- **データベース操作**: SQLiteデータベースへの予測履歴の保存と取得
- **静的ファイル配信**: ビルド済みフロントエンドの配信（本番環境）

#### 機械学習層（機械学習API）

機械学習層は、予測処理を担当する層である。FastAPI、Python、R言語を使用して実装されており、以下の機能を提供する。

- **モデル管理**: 19個のランダムフォレストモデル（.rdsファイル）の読み込みと管理
- **予測実行**: 入力データを基にした各FIM項目の予測
- **データ変換**: JSON形式の入力データをRのデータフレーム形式に変換し、予測結果をJSON形式で返却
- **rpy2連携**: PythonからR言語を呼び出すためのライブラリ（rpy2 3.5.14）を使用

## 2. 技術スタック

### 2.1 フロントエンド技術

| 技術 | バージョン | 用途 |
|------|-----------|------|
| React | 19.2.0 | UI構築のためのJavaScriptライブラリ |
| Vite | 7.2.6 | 高速な開発サーバーとビルドツール |
| React Router DOM | 7.10.1 | クライアントサイドルーティング |
| Recharts | 3.5.1 | データ可視化（レーダーチャート） |

### 2.2 バックエンド技術

| 技術 | バージョン | 用途 |
|------|-----------|------|
| Node.js | - | JavaScript実行環境 |
| Express | 5.2.1 | Webアプリケーションフレームワーク |
| SQLite3 | 5.1.7 | リレーショナルデータベース |
| Axios | 1.6.2 | HTTPクライアントライブラリ |

### 2.3 機械学習技術

| 技術 | バージョン | 用途 |
|------|-----------|------|
| Python | - | 機械学習APIの実装言語 |
| FastAPI | 0.104.1 | 高性能なWeb APIフレームワーク |
| R言語 | - | 機械学習モデルの学習・実行環境 |
| rpy2 | 3.5.14 | PythonからRを呼び出すためのライブラリ |
| pandas | 2.1.4 | データ操作ライブラリ |
| numpy | 1.26.2 | 数値計算ライブラリ |
| uvicorn | 0.24.0 | ASGIサーバー |

### 2.4 機械学習アルゴリズム

- **ランダムフォレスト（Random Forest）**: R言語の`caret`パッケージを使用して実装
- **モデル数**: 19個（総合予測1個、運動機能合計1個、認知機能合計1個、運動機能項目12個、認知機能項目5個）

## 3. データフロー

### 3.1 予測処理のフロー

1. **ユーザー入力**（フロントエンド）
   - フォームに入力データを入力
   - クライアントサイドでのバリデーション実行

2. **APIリクエスト送信**（フロントエンド → バックエンド）
   - `POST /api/predict`エンドポイントにJSON形式で送信
   - リクエストボディには個人情報とFIM値が含まれる

3. **リクエスト転送**（バックエンド → 機械学習API）
   - バックエンドがR FastAPIサーバー（`http://localhost:5000/predict`）にリクエストを転送
   - タイムアウト設定（10秒）により、長時間の処理を防止

4. **予測処理実行**（機械学習API）
   - 入力データをRのデータフレーム形式に変換
   - 各項目のランダムフォレストモデルで予測を実行
   - 予測値は0〜7の範囲に制限（FIMスコアの範囲）

5. **予測結果の返却**（機械学習API → バックエンド）
   - 予測結果をJSON形式で返却
   - 運動機能項目12個、認知機能項目5個、合計値（運動機能合計、認知機能合計、総合得点）

6. **データベース保存**（バックエンド）
   - 予測結果をSQLiteデータベースに保存
   - 入力データと予測結果の両方を保存

7. **結果表示**（バックエンド → フロントエンド）
   - 予測結果をJSON形式で返却
   - フロントエンドがレーダーチャートとテーブルで表示

### 3.2 データ形式

#### リクエスト形式（POST /api/predict）

```json
{
  "gender": "male" | "female",
  "age": number,
  "bmi": number,
  "careLevel": "yes" | "no",
  "daysFromOnset": number,
  "motionValues": {
    "食事": number,
    "整容": number,
    "清拭": number,
    "更衣上半身": number,
    "更衣下半身": number,
    "トイレ動作": number,
    "排尿管理": number,
    "排便管理": number,
    "ベッド移乗": number,
    "トイレ移乗": number,
    "浴槽移乗": number,
    "歩行": number
  },
  "cognitiveValues": {
    "理解": number,
    "表出": number,
    "社会的交流": number,
    "問題解決": number,
    "記憶": number
  }
}
```

#### レスポンス形式

```json
{
  "motion": [number, number, ...],  // 12個の運動機能項目の予測値
  "cognitive": [number, number, ...], // 5個の認知機能項目の予測値
  "motionTotal": number,              // 運動機能合計
  "cognitiveTotal": number,           // 認知機能合計
  "total": number                     // 総合得点
}
```

## 4. データベース設計

### 4.1 データベース構成

本システムでは、SQLiteデータベースを使用して予測履歴と患者データを管理する。

#### テーブル: prediction_history

予測履歴を保存するテーブル。各予測実行時に、入力データと予測結果の両方が保存される。

| カラム名 | データ型 | 説明 |
|---------|---------|------|
| id | INTEGER PRIMARY KEY | 主キー（自動採番） |
| created_at | DATETIME | 予測実行日時（デフォルト: CURRENT_TIMESTAMP） |
| input_gender | INTEGER | 入力性別（0: 男性、1: 女性） |
| input_age | REAL | 入力年齢 |
| input_bmi | REAL | 入力BMI |
| input_care_level | INTEGER | 入力要介護度（0: なし、1: あり） |
| input_days_from_onset | REAL | 入力発症から入棟までの日数 |
| input_motion_values | TEXT | 入力運動機能値（JSON形式） |
| input_cognitive_values | TEXT | 入力認知機能値（JSON形式） |
| predicted_motion | TEXT | 予測運動機能値（JSON形式） |
| predicted_cognitive | TEXT | 予測認知機能値（JSON形式） |
| predicted_motion_total | REAL | 予測運動機能合計 |
| predicted_cognitive_total | REAL | 予測認知機能合計 |
| predicted_total | REAL | 予測総合得点 |

#### テーブル: patient_data

患者データを保存するテーブル（学習データとして使用）。

| カラム名 | データ型 | 説明 |
|---------|---------|------|
| id | INTEGER PRIMARY KEY | 主キー |
| gender | INTEGER | 性別 |
| age | REAL | 年齢 |
| bmi | REAL | BMI |
| care_level | INTEGER | 要介護度 |
| days_from_onset | REAL | 発症から入棟までの日数 |
| admission_motion | TEXT | 入院時運動機能値（JSON形式） |
| admission_cognitive | TEXT | 入院時認知機能値（JSON形式） |
| discharge_motion | TEXT | 退院時運動機能値（JSON形式） |
| discharge_cognitive | TEXT | 退院時認知機能値（JSON形式） |

## 5. システムの特徴

### 5.1 アーキテクチャの特徴

1. **3層アーキテクチャ**: プレゼンテーション層、アプリケーション層、機械学習層を明確に分離
2. **マイクロサービス的設計**: 各層が独立して動作し、HTTP/JSONで通信
3. **言語の多様性**: JavaScript（Node.js）、Python、R言語を適材適所で使用

### 5.2 技術的優位性

1. **高速な開発環境**: Viteによる高速なホットリロード
2. **型安全性**: TypeScriptの使用（将来的な拡張）
3. **RESTful API**: 標準的なREST API設計
4. **非同期処理**: Node.jsの非同期処理による高いパフォーマンス

### 5.3 保守性と拡張性

1. **モジュール化**: 各機能を独立したモジュールとして実装
2. **設定の外部化**: 環境変数による設定管理
3. **エラーハンドリング**: 適切なエラーメッセージとステータスコードの返却
4. **ログ機能**: 予測処理のログ記録

## 6. セキュリティ対策

### 6.1 実装されている対策

1. **CORS設定**: クロスオリジンリソース共有の適切な設定
2. **入力検証**: フロントエンドとバックエンドの両方で入力データの検証
3. **エラーハンドリング**: 適切なエラーメッセージとステータスコードの返却
4. **タイムアウト設定**: 長時間の処理を防止するタイムアウト設定

### 6.2 今後の改善点

1. **認証・認可**: ユーザー認証機能の追加
2. **HTTPS**: 本番環境でのHTTPS通信の実装
3. **入力サニタイゼーション**: SQLインジェクション対策の強化
4. **レート制限**: APIの過剰な呼び出しを防止

## 7. パフォーマンス最適化

### 7.1 実装されている最適化

1. **モデルの事前読み込み**: アプリケーション起動時にすべてのモデルをメモリに読み込み
2. **非同期処理**: Node.jsの非同期処理により、複数のリクエストを効率的に処理
3. **静的ファイルの配信**: ビルド済みフロントエンドの効率的な配信
4. **データベースインデックス**: 予測履歴の高速検索のためのインデックス

### 7.2 パフォーマンス指標

- **予測処理時間**: 通常、数秒以内に完了
- **APIレスポンス時間**: 平均1〜3秒
- **同時接続数**: 非同期処理により、複数のリクエストを同時に処理可能

## 8. デプロイメント構成

### 8.1 開発環境

- **フロントエンド**: Vite開発サーバー（`npm run dev`、Port: 5173）
- **バックエンド**: Node.jsサーバー（`npm run server`、Port: 3001）
- **機械学習API**: FastAPIサーバー（`python predict_api_fastapi.py`、Port: 5000）

### 8.2 本番環境

- **ビルド**: フロントエンドを`npm run build`でビルド
- **サーバー**: Node.jsサーバーが静的ファイルとAPIの両方を提供（Port: 3001）
- **プロセス管理**: PM2を使用したプロセス管理（推奨）
- **デプロイ先**: VPS（さくらのVPSなど）へのデプロイに対応

## 9. システムの制約事項

### 9.1 技術的制約

1. **Rモデルの依存性**: R言語とrpy2ライブラリが必要
2. **シングルスレッド**: Node.jsのシングルスレッドモデルによる制約
3. **メモリ使用量**: 19個のモデルをメモリに保持するため、一定のメモリが必要

### 9.2 運用上の制約

1. **3つのサーバープロセス**: フロントエンド、バックエンド、機械学習APIの3つのプロセスが必要
2. **ポート管理**: 各サーバーが異なるポートを使用するため、ポート管理が必要
3. **環境依存**: R言語とPythonの環境構築が必要

## 10. 今後の拡張計画

### 10.1 機能拡張

1. **モデルの再学習機能**: 新しいデータが蓄積された際のモデルの再学習
2. **予測精度の向上**: より高度な機械学習アルゴリズムの導入
3. **レポート機能**: 予測結果の詳細レポート生成
4. **ユーザー管理**: 複数のユーザーによる利用を想定した認証機能

### 10.2 技術的改善

1. **コンテナ化**: Dockerによる環境の統一
2. **CI/CD**: 継続的インテグレーション・継続的デプロイメントの導入
3. **モニタリング**: システムの監視とログ管理
4. **負荷分散**: 複数のサーバーによる負荷分散
