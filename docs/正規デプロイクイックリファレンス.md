# 正規デプロイ クイックリファレンス

## 前提条件
- VPS IP: 160.16.92.115
- ユーザー: ubuntu
- GitHub: https://github.com/jasminetea-hub/FIM-system.git

## 1. VPSに接続

```powershell
ssh ubuntu@160.16.92.115
```

## 2. システムセットアップ（初回のみ）

```bash
# システム更新
sudo apt update && sudo apt upgrade -y

# 必要なパッケージ
sudo apt install -y curl wget git build-essential

# Node.js 18.x
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# PM2
sudo npm install -g pm2

# ファイアウォール
sudo ufw allow 22/tcp
sudo ufw allow 3001/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

## 3. PM2自動起動設定

```bash
pm2 startup systemd
# 表示されたコマンドを実行
pm2 save
```

## 4. アプリケーションデプロイ

```bash
# ディレクトリ作成
mkdir -p ~/www
cd ~/www

# クローン
git clone https://github.com/jasminetea-hub/FIM-system.git .

# セットアップ
npm install --production
npm run build
npm run init-db
mkdir -p logs
cp .htaccess.example .htaccess

# 環境変数
echo "NODE_ENV=production" > .env
echo "PORT=3001" >> .env
chmod 600 .env

# 起動
pm2 start ecosystem.r.config.js
pm2 save
pm2 status
```

## 5. Nginx設定（オプション）

```bash
# インストール
sudo apt install nginx -y

# 設定ファイル作成
sudo nano /etc/nginx/sites-available/fim-prediction
```

設定内容（`/etc/nginx/sites-available/fim-prediction`）:
```nginx
server {
    listen 80;
    server_name 160.16.92.115;
    
    location / {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

```bash
# 有効化
sudo ln -s /etc/nginx/sites-available/fim-prediction /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

## 6. 動作確認

```bash
# PM2ステータス
pm2 status
pm2 logs fim-prediction

# ローカルテスト
curl http://localhost:3001

# ブラウザで確認
# http://160.16.92.115:3001
```

## 更新時のデプロイ

```bash
cd ~/www
git pull origin main
npm install --production
npm run build
pm2 restart fim-prediction
pm2 logs fim-prediction --lines 20
```

## トラブルシューティング

```bash
# ログ確認
pm2 logs fim-prediction --lines 100

# 手動起動テスト
cd ~/www
node server_r_model.js

# ポート確認
sudo netstat -tlnp | grep 3001
```

詳細は `docs/正規的なVPSデプロイ手順.md` を参照してください。

