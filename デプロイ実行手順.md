# さくらのVPSデプロイ実行手順

## 前提条件
- **VPSユーザー名**: ubuntu
- **VPSパスワード**: sakura.ubuntu1127
- **VPSホスト名**: sakuraubuntu

## ステップ1: GitHubリポジトリの作成とプッシュ

### 1-1. Gitリポジトリを初期化

PowerShellで実行：

```powershell
# 現在のディレクトリで実行
git init
git add .
git commit -m "Initial commit for deployment"
```

### 1-2. GitHubリポジトリを作成

1. GitHubにログイン
2. 新しいリポジトリを作成（例: `fim-prediction-app`）
3. リポジトリURLをコピー

### 1-3. リモートリポジトリを追加してプッシュ

```powershell
# リモートリポジトリを追加（[ユーザー名]と[リポジトリ名]を置き換え）
git remote add origin https://github.com/[ユーザー名]/[リポジトリ名].git
git branch -M main
git push -u origin main
```

## ステップ2: VPSのIPアドレスを確認

さくらのコントロールパネルでVPSのIPアドレスを確認してください。

または、以下のコマンドで確認を試みます：

```powershell
# PowerShellで
Resolve-DnsName sakuraubuntu -Type A
```

## ステップ3: VPSにSSH接続

IPアドレスが分かったら、PowerShellで接続：

```powershell
ssh ubuntu@sakuraubuntu
```

または：

```powershell
ssh ubuntu@[IPアドレス]
```

初回接続時は `yes` を入力し、パスワード `sakura.ubuntu1127` を入力します。

## ステップ4: VPS上でセットアップ（接続後）

VPSに接続後、以下のコマンドを順番に実行：

```bash
# 1. システムを更新
sudo apt update && sudo apt upgrade -y

# 2. Node.js 18.xをインストール
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# バージョンを確認
node --version
npm --version

# 3. Gitをインストール
sudo apt install git -y
git --version

# 4. PM2をインストール
sudo npm install -g pm2
pm2 --version

# 5. デプロイディレクトリを作成
mkdir -p ~/www
cd ~/www
```

## ステップ5: GitHubからクローン

```bash
# GitHubリポジトリをクローン（[ユーザー名]と[リポジトリ名]を置き換え）
git clone https://github.com/[ユーザー名]/[リポジトリ名].git .

# 依存関係をインストール
npm install --production

# フロントエンドをビルド
npm run build

# データベースを初期化
npm run init-db

# ログディレクトリを作成
mkdir -p logs

# .htaccessを設定
cp .htaccess.example .htaccess
```

## ステップ6: PM2でアプリケーションを起動

```bash
# PM2でアプリケーションを起動
pm2 start ecosystem.config.js

# 自動起動を設定
pm2 startup
# 表示されたコマンドを実行（sudoが必要な場合があります）

pm2 save

# ステータス確認
pm2 status

# ログ確認
pm2 logs fim-prediction
```

## ステップ7: ファイアウォールの設定

```bash
# ポート3001を開放
sudo ufw allow 3001/tcp

# ファイアウォールの状態を確認
sudo ufw status

# ファイアウォールを有効化（まだの場合）
sudo ufw enable
```

## ステップ8: 動作確認

ブラウザで以下のURLにアクセス：

```
http://[VPSのIPアドレス]:3001
```

## トラブルシューティング

### SSH接続できない場合

1. IPアドレスが正しいか確認
2. ファイアウォールでSSHポート（22）が開放されているか確認
3. さくらのコントロールパネルでVPSの状態を確認

### Node.jsのインストールに失敗する場合

```bash
# 古いNode.jsを削除
sudo apt remove nodejs npm -y
sudo apt autoremove -y

# 再度インストール
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs
```

### PM2が起動しない場合

```bash
# ログを確認
pm2 logs fim-prediction --lines 50

# エラーの詳細を確認
pm2 describe fim-prediction

# 手動で起動してエラーを確認
cd ~/www
node server.js
```

### ポート3001にアクセスできない場合

```bash
# アプリケーションが起動しているか確認
pm2 status

# ローカルでアクセスできるか確認
curl http://localhost:3001

# ファイアウォールの設定を確認
sudo ufw status
```

## 次のステップ

デプロイが完了したら：

1. **Nginxの設定**: リバースプロキシを設定してポート80でアクセス可能にする
2. **SSL証明書**: Let's EncryptでHTTPSを有効化
3. **ドメインの設定**: 独自ドメインを設定

詳細は `docs/さくらのVPSデプロイ手順.md` を参照してください。

